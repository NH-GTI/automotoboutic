<?php
/*
StoreCommander
*/
 class ExternHall { const EXTRA_PARAMS_KEY = "\145\x78\x74\162\x61\137\x70\x61\162\141\155\163"; private $allowedScIp; private $classNameByAction = array("\x75\163\x61\x67\145" => "\105\170\x74\145\162\156\110\x61\x6c\154\x55\163\141\147\x65", "\x61\x75\x74\157\x75\x70\x64\x61\164\x65" => "\x45\170\x74\145\x72\x6e\110\141\154\x6c\101\x75\x74\x6f\125\160\x64\141\164\x65"); private $actionNeedTrendsCheckup = array("\165\163\141\147\x65"); private $allowedProcess; private $allowedAction; private $extraParamsArray; private $process; private $action; private $distantIpReceived; private $extraParams; private $token; private $paramServer; public function __construct($server) { goto rr3qZ; rr3qZ: $this->allowedScIp = gethostbyname("\163\164\157\x72\x65\143\157\155\155\x61\156\x64\x65\162\x2e\x63\x6f\x6d"); goto ecdnm; ecdnm: $this->allowedAction = array_keys($this->classNameByAction); goto NZ6vI; NZ6vI: $this->paramServer = $server; goto rBA5V; rBA5V: } public function setPropertiesFromServer() { goto CWuV9; JKZ2k: $this->distantIpReceived = array_key_exists("\110\124\124\x50\137\130\x5f\x53\x43\x5f\x49\x50\x5f\x52\105\106\105\x52\105\122", $this->paramServer) ? (string) $this->paramServer["\x48\x54\124\x50\137\130\x5f\123\x43\137\x49\120\x5f\122\105\x46\x45\x52\x45\122"] : null; goto xrdKk; ACdv0: $this->extraParams = json_decode(file_get_contents("\160\150\160\x3a\57\57\x69\x6e\x70\165\164"), true); goto JKZ2k; CWuV9: $this->token = array_key_exists("\x48\x54\124\x50\x5f\x58\x5f\x53\103\x5f\x54\117\113\x45\x4e", $this->paramServer) ? (string) $this->paramServer["\110\x54\x54\120\137\130\137\123\x43\x5f\x54\117\113\105\116"] : null; goto f7dX6; f7dX6: $this->action = array_key_exists("\110\x54\124\x50\137\x58\137\123\103\137\101\103\x54\x49\x4f\x4e", $this->paramServer) ? $this->paramServer["\x48\x54\124\120\137\x58\x5f\x53\x43\137\x41\103\124\111\117\116"] : null; goto ACdv0; xrdKk: } public function isValidEntrance() { goto Y32S7; z0fwB: return true; goto GC02b; Y32S7: if (!(!$this->isWhiteListedIp() || !$this->isAllowedAction() || $this->extraParams !== null && !$this->isValidExtraParams())) { goto aJugI; } goto sz9IN; hIN6Q: aJugI: goto z0fwB; sz9IN: return false; goto hIN6Q; GC02b: } protected function setExtraParams() { goto qeQUO; yiG0s: $this->extraParamsArray = $this->extraParams[ExternHall::EXTRA_PARAMS_KEY]; goto mn1hj; G8Ra8: FyMf6: goto yiG0s; d0KYp: return array(); goto G8Ra8; qeQUO: if (is_array($this->extraParams)) { goto FyMf6; } goto d0KYp; mn1hj: } public function isValidToken() { $localToken = (string) hash("\x73\x68\141\65\x31\x32", Configuration::get("\123\103\137\x4c\x49\x43\105\x4e\x53\x45\x5f\x4b\105\131", false, 0, 0)); return $this->token === $localToken; } public function allowSendingData() { goto R2csB; ZltzX: $settings = json_decode(Configuration::get("\x53\x43\x5f\123\105\x54\124\111\x4e\107\x53", null, 0, 0), true); goto jEIxP; R1L1T: H07tQ: goto ZltzX; WGsW5: return true; goto R1L1T; TTIwt: return false; goto tyvVx; tyvVx: qdKaS: goto JEu9J; jEIxP: if (!(!empty($settings) && array_key_exists("\101\120\x50\x5f\x54\x52\105\x4e\x44\123", $settings) && (int) $settings["\101\120\120\x5f\x54\122\105\x4e\104\x53"] != 1)) { goto qdKaS; } goto TTIwt; JEu9J: return true; goto iDBUf; R2csB: if (in_array($this->action, $this->actionNeedTrendsCheckup)) { goto H07tQ; } goto WGsW5; iDBUf: } public function doProcess() { goto ewUqO; zmJfD: $this->setExtraParams(); goto exsY6; exsY6: $scFolderHash = Configuration::get("\123\103\x5f\x46\x4f\114\104\105\x52\137\110\x41\x53\x48", null, 0, 0); goto vuG21; dXFmM: $actionObject->doProcess(); goto FqpKo; vwPct: if (file_exists(_PS_MODULE_DIR_ . $currentScFolderName . "\x2f" . $scFolderHash)) { goto VjVLk; } goto kT75s; Q9AbJ: $CRON = true; goto ykzM8; Qdp5I: $actionObject = new $actionClassName($this->extraParamsArray); goto dXFmM; zw0eE: VjVLk: goto oxhGD; kT75s: return; goto zw0eE; ykzM8: $_POST = array("\141\143\164\x69\x6f\x6e" => "\x6d\x61\x70\160\151\x6e\147\137\x70\x72\157\143\x65\x73\x73", "\x61\x6a\141\170" => 1); goto ntA3d; ewUqO: global $default_settings, $local_settings, $custom_settings; goto zmJfD; vuG21: if (!empty($scFolderHash)) { goto TkTm_; } goto nCkft; oxhGD: require_once _PS_MODULE_DIR_ . $currentScFolderName . "\57" . $scFolderHash . "\57\123\x43\x2f\151\156\x69\x74\137\163\143\x2e\160\x68\x70"; goto h7ujs; h7ujs: $actionClassName = (string) $this->classNameByAction[$this->action]; goto Qdp5I; ntA3d: $currentScFolderName = basename(realpath("\x2e\56\57\x2e\56\57")); goto vwPct; o3Aq3: TkTm_: goto Q9AbJ; nCkft: $scFolderHash = Configuration::get("\x53\x43\x5f\106\117\x4c\x44\105\122\137\110\101\123\110"); goto o3Aq3; FqpKo: } public function exitPage($code) { goto p2rx2; p2rx2: switch ($code) { case 403: header("\110\x54\x54\120\57\x31\x2e\x31\40\64\x30\x33\40\x46\157\162\142\151\144\144\x65\x6e"); goto OjqEO; default: header("\110\124\x54\x50\x2f\61\56\x31\x20\x32\x30\60\x20\117\113"); } goto GSTeR; tC3aN: die; goto hk4CI; DlJxz: OjqEO: goto tC3aN; GSTeR: DB4BN: goto DlJxz; hk4CI: } public function isModuleInstalledAndEnable($scFolder) { goto x5r0M; MRJ3M: Z95t1: goto BCP3U; E3Sd3: return false; goto cGCzS; liKRn: $scInstalled = Module::isInstalled($scFolder); goto DSqC5; nnCXl: Rmo9L: goto xCzZ6; BCP3U: if (!(!$scInstalled || !Module::isEnabled($scFolder))) { goto HAgLb; } goto E3Sd3; cGCzS: HAgLb: goto wrXRX; W_02j: $moduleDataProvider = new PrestaShop\PrestaShop\Adapter\Module\ModuleDataProvider($legacyLogger, Context::getContext()->getTranslator()); goto Iyh3w; x5r0M: if (version_compare(_PS_VERSION_, "\x31\56\67", "\x3e\x3d")) { goto Rmo9L; } goto liKRn; Iyh3w: $scInstalled = $moduleDataProvider->isInstalled($scFolder); goto MRJ3M; DSqC5: goto Z95t1; goto nnCXl; xCzZ6: $legacyLogger = new PrestaShop\PrestaShop\Adapter\LegacyLogger(); goto W_02j; wrXRX: return true; goto N1TKs; N1TKs: } private function isWhiteListedIp() { return $this->allowedScIp == $this->distantIpReceived; } private function isAllowedAction() { return in_array($this->action, $this->allowedAction); } private function isValidExtraParams() { return is_array($this->extraParams) && array_key_exists(ExternHall::EXTRA_PARAMS_KEY, $this->extraParams); } }
